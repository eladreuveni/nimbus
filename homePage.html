<!DOCTYPE html>
<html dir="rtl" lang="he">
  <head>
    <base target="_top">
    <!-- <?!= include('styleHomePage'); ?> -->
    <style>
      :root {
        --page-bg-color: #f1f7ff;
        --form-bg-color: #fff;
        --main-title-color: #0a3667;
        --reg-text-color: #0b3058;
        --gray-text-color: #7b7b7b;
        --active-button-color: #0068f5;
        --active-button-hover-color: #0066d4;
        --active-button-click-color: #0047d4;
        --disabled-button-color: #b6c0cc;
        --input-filled-bg: #FAFAFA;
        --active-button-green: #4CAF50;
        --active-button-hover-green: #388E3C ;
      }
      html, body {
        font-family: Calibri;
        font-size: 16px;
        margin: 0;
        padding: 0;
        background-color: var(--page-bg-color);
        direction: rtl;
      }
      h1 {
        font-size: 1.5rem;
      }
      h2 {
        font-size: 1.25rem
      }
      .info-icon {
        cursor: default;
        position: relative;
        display: inline-block;
        vertical-align: top; /* Align vertically with the text */
        margin-right: 5px; /* Adjust spacing between the question text and the icon */
      }

      .tooltiptext {
        position: absolute;
        font-family: Calibri;
        visibility: hidden;
        background-color: #555;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 1;
      }
      .info-icon .tooltiptext {
        top: 100%;
        left: 50%;
        width: 160px;
        margin-left: -80px;
      }

      .number-button .tooltiptext {
        font-size: 1rem;
        width: max-content;
        top: 110%;
        left: 50%;
        transform: translate(-50%);
      }

      .expand-btn .tooltiptext {
        width: max-content;
        top: 110%;
        left: 50%;
        transform: translate(-50%);
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      .question {
        display: inline-block;
        vertical-align: top;
        margin-right: 10px; 
      }

      

      #page1,
      #page2,
      #page3,
      #page4,
      #page5 {
        margin: 0 auto;
        width: 90%;
        display: none; /* Hide all pages initially */
      }

      .group-container {
        background-color: var(--form-bg-color);
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        padding: 1.25rem;
        margin-bottom: 3rem;
      }
      .group-container p {
        font-size: 1.2rem;
      }

      .single-question-container {
        margin: 3rem 0;
      }
      .single-question-container div {
        margin-bottom: 10px;
      }
      .single-question-flex {
        display: flex;
        align-items: center;
      }
      .single-question-container.single-question-flex div {
        margin-left: 20px;
        margin-bottom: 0px;
      }

      #change-project:disabled {
        cursor: not-allowed;
        color: white;
        background: gray;
      }

      input[type="text"],
      select,
      input[type="radio"],
      input[type="number"],
      input[type="date"] {
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1.1rem;
      }

      .input-long {
        width: 100%;
      }
      label {
        font-size: 1.1rem;
      }

      td select {
        width: 100%;
      }
      .input-gray-bg {
        background-color: var(--input-filled-bg);
      }

      button {
        display: block;
        padding: 10px 20px;
        background-color: var(--active-button-color);
        color: var(--form-bg-color);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
      }

      button:hover:enabled {
        color: white;
        background-color: var(--active-button-hover-color);
      }
      button:active:enabled {
        color: white;
        background-color: var(--active-button-click-color);
      }

      #surveyTitle {
        display: inline-block; /* Make the survey title inline-block to allow other elements to be on the same line */
        margin-right: 20px; /* Adjust spacing between survey title and header */
      }

      

      #officeTitle,
      #projectTitle {
        margin-right: 20px;// Adjust spacing between titles and dropdown
      }

      #header {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        margin-right: 2rem;
      }
      #header h1,
      #header h2 {
        margin: 0;
      }
      #header #logo {
        height: 12vh;
        width: auto;
      }

      #header #titles {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        /* gap: 0.5rem; */
      }

      #project-dropdown {
        display: flex;
        align-items: center;
        gap: 1rem;
        visibility: visible;
        margin-right: calc(12vh + 3rem); // depends on img height and the margins!!
        margin-top: 1rem;
      }

      #project-name-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 3px;
      }
      #project-dropdown label, .header-label {
        color: var(--gray-text-color);
        font-size: 1.1rem;
      }

      #project-dropdown button {
        margin-right: 10px;
      }

      .button-small {
      display: inline-block; /* Display the button inline */
      vertical-align: middle; /* Align the button vertically with the text */
      padding: 5px 10px; /* Adjust padding to make the button smaller */
      font-size: 0.75rem; /* Reduce font size for a smaller button */
      background-color: var(--active-button-color); /* Same background color as other buttons */
      color: var(--form-bg-color); /* White text color */
      border: none; /* No border */
      border-radius: 4px; /* Rounded corners */
      cursor: pointer; /* Show pointer cursor on hover */
      }

      .button-small:hover {
        background-color: #0056b3; /* Darker background color on hover */
      }
      .question-desc {
        display: inline-block;
        vertical-align: middle; /* Align vertically with the icon */
        font-weight: bold;
      }
      .question-text {
        font-size: 1.1rem;
      }

      .required-star {
          color: red;
          margin-right: 2px; /* Adjust spacing between the icon and the red star */
          vertical-align: top; /* Align vertically with the text */
      }
      

      #page2 {
        overflow-x: auto; /* Enable horizontal scrolling if the table overflows */
      }

      .question-table {
        width: 100%; /* Adjust the width of the table to fill the container */
        /* max-width: 100%; Ensure the table doesn't exceed the container width */

        max-width: none;

        margin: 0; /* Remove margin to prevent extending beyond the container */
        padding: 0; /* Remove padding to prevent extending beyond the container */
        border-collapse: collapse; /* Collapse table borders */
      }

      .question-table th,
      .question-table td {
        border: 1px solid #ddd; /* Add border to table cells */
        padding: 5px; /* Add padding to table cells */
        text-align: center; /* Center align table cell content */
      }
      #miles-table th,
      #miles-table td {
        height: 15vh;
      }
      .question-table input,
      .question-table select,
      .question-table textarea {
        width: 100%;
        font: inherit;
      }
      .question-table textarea {
        height: 100%;
        resize: none;
        padding: 5px;
        box-sizing: border-box;
      }
      .button-container {
        text-align: center;
        position: relative;
      }
      .number-button {
        display: inline-block;
        font-family: Comic Sans MS;
        border-radius: 50%;
        background-color: white;
        color: black;
        text-align: center;
        font-size: 1.25rem;
        margin: 15px;
        cursor: pointer;
        position: relative; /* Make sure buttons have a stacking context */
        z-index: 1; /* Ensure buttons are above the line */

      .number-button:disabled {
        cursor: not-allowed;
      }

      .page-ms-disabled {
        background-color: var(--disabled-button-color) !important;
      }

      .menu-button-highlighted {
        color: white;
        background-color: var(--active-button-color)
      }
      .line {
        position: absolute;
        width: calc(100% - 50px); /* Set line width to cover space between buttons */
        height: 2px;
        background-color: #D3D3D3;
        top: 50%; /* Position the line at the vertical center of the button container */
        left: 25px; /* Adjust left position to center the line between buttons */
        transform: translateY(-50%);
        z-index: 0; /* Ensure line is behind the buttons */
      }
      .add-button-row{
        display: inline-block;
        vertical-align: bottom;
      }
      .multi-checkbox-div {
        display: flex;
        flex-direction: column
      }

      // loader
      .lds-default {
        /* change color here */
        color: #1c4c5b;
        right: 50%;
        transform: translate(50%, 0);
      }
      .lds-default,
      .lds-default div {
        box-sizing: border-box;
      }
      .lds-default {
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
      }
      .lds-default div {
        position: absolute;
        width: 6.4px;
        height: 6.4px;
        background: currentColor;
        border-radius: 50%;
        animation: lds-default 1.2s linear infinite;
      }
      .lds-default div:nth-child(1) {
        animation-delay: 0s;
        top: 36.8px;
        left: 66.24px;
      }
      .lds-default div:nth-child(2) {
        animation-delay: -0.1s;
        top: 22.08px;
        left: 62.29579px;
      }
      .lds-default div:nth-child(3) {
        animation-delay: -0.2s;
        top: 11.30421px;
        left: 51.52px;
      }
      .lds-default div:nth-child(4) {
        animation-delay: -0.3s;
        top: 7.36px;
        left: 36.8px;
      }
      .lds-default div:nth-child(5) {
        animation-delay: -0.4s;
        top: 11.30421px;
        left: 22.08px;
      }
      .lds-default div:nth-child(6) {
        animation-delay: -0.5s;
        top: 22.08px;
        left: 11.30421px;
      }
      .lds-default div:nth-child(7) {
        animation-delay: -0.6s;
        top: 36.8px;
        left: 7.36px;
      }
      .lds-default div:nth-child(8) {
        animation-delay: -0.7s;
        top: 51.52px;
        left: 11.30421px;
      }
      .lds-default div:nth-child(9) {
        animation-delay: -0.8s;
        top: 62.29579px;
        left: 22.08px;
      }
      .lds-default div:nth-child(10) {
        animation-delay: -0.9s;
        top: 66.24px;
        left: 36.8px;
      }
      .lds-default div:nth-child(11) {
        animation-delay: -1s;
        top: 62.29579px;
        left: 51.52px;
      }
      .lds-default div:nth-child(12) {
        animation-delay: -1.1s;
        top: 51.52px;
        left: 62.29579px;
      }
      @keyframes lds-default {
        0%, 20%, 80%, 100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.5);
        }
      }

      .prev-next-btns {
        margin: 10px auto;
        width: 90%;
      }
      .prev-next-btns-flex {
        display: flex;
        width: 100%;
        gap: 40px;
        justify-content: center;
      }
      .prev-next-btns .quit-btn {
        background-color: var(--active-button-green);
      }
      .prev-next-btns .quit-btn:hover:enabled {
        background-color: var(--active-button-hover-green);
      }

      .btns-cell {
        display: flex;
        justify-content: space-around;
        gap: 1vh;
      }
      .btns-cell button {
        padding: 0;
        width: 4vh;
        height: 4vh;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .btns-cell button .fa {
        font-size: 2.5vh;
      }
      #plan-image {
        width: 40%;
        position: absolute;
        top: 15%;
        left: 10%;
      }
      #page-intro {
        width: 90%;
        margin: auto;
      }
      #page-desc-placeholder {
        font-size: 1.15rem;
        text-wrap: wrap;
        line-height: 2rem;
      }
      .trainings-page-table input[type="number"] {
        width: 80%;
      }
      .role-table td h3 {
        margin: 1rem 0;
      }
      #role-popup {
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
      }

      #role-popup.show {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      #role-popup.hide {
        display: none;
      }

      #role-popup .popup-content {
        background-color: #fff;
        padding: 20px;
        border: 1px solid #888;
        width: 50%;
        max-height: 75%;
        border-radius: 8px;
        position: relative;
        overflow-y: scroll;
      }
      .training-table td h3 {
        font-size: 1rem;
        margin: 0;
      }
      .training-table tr th:first-child {
        width: 70%;
      }
      .trainings-page-table .roles-table-name-cell {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .trainings-page-table .info-icon .tooltiptext {
        width: 500px;
        margin-left: -250px;
      }

      #role-popup .close-btn {
        font-size: 3rem;
        cursor: pointer;
      }

      .single-role-popup-data .sug-training {
        margin-bottom: 1rem;
      }
      .single-role-popup-data .sug-training .training-path-name-span {
        font-weight: bold;
      }
      #role-popup .popup-top-row {
        display: flex;
        align-items: center;
      }
      #role-popup .popup-top-row div {
        flex: 1;
      }
      #role-popup .popup-top-row h2 {
        text-align: center;
        flex: 5;
        margin: 0;
      }
      #role-popup .popup-top-row .flex-item button {
        margin-right: auto;
      }
      #role-popup tr.hide-row {
        display: none;
      }
      #role-popup .cloud-data {
        font-size: 1.2rem;
        margin: 0.5rem 0 2rem 0;
      }
      #role-popup .cloud-data .cloud-label {
        margin-left: 0.5rem;
      }
      #role-popup .training-journey-container {
        margin-bottom: 5rem;
      }
      #role-popup .training-journey-container h3 {
        text-align: center;
      }
      .expand-btn {
        margin: auto;
        padding: 5px;
        display: flex;
        position: relative;
      }
      .expand-btn .expand-icon {
        width: 1.5rem;
      }
      .expand-btn:disabled {
        background-color: var(--disabled-button-color);
        cursor: default;
      }
      #page-thank-you {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
<body>
  <div id="header">
    <img id="logo" alt="לוגו מערך הדיגיטל"
      src="https://storageaccountpbiema3c5.blob.core.windows.net/icons/Israel_National_Digital_Agency_Logo.png" />
    <div id="titles">
      <h1 id="survey-name">מדד הכשירות ומעקב אחר פרויקטים למעבר לנימבוס</h1>
      <h2 id="office-name-placeholder"></h2>
      <div id="project-name-container" style="visibility: hidden;">
        <span class="header-label">שם הפרויקט:</span>
        <h2 id="project-name-placeholder"></h2>
      </div>
    </div>
  </div>
  <div id="project-dropdown" style="visibility: hidden;">
    <label for="project-selection-dropdown">בחר פרויקט: </label>
    <select id="project-selection-dropdown" onchange="selectProjectInDropdown(this)">
      <!-- Project options will be populated here -->
    </select>
    <button id="change-project" onclick="confirmProjectChange()" disabled>שנה פרויקט</button>
  </div>

  <div class="button-container">
      <button id="top-menu-page1" onclick="pageNumberMenuClicked('1')" class="number-button tooltip menu-button-highlighted" disabled>1</button>
      <button id="top-menu-page2" onclick="pageNumberMenuClicked('2')" class="number-button tooltip" disabled>2</button>
      <button id="top-menu-page3" onclick="pageNumberMenuClicked('3')" class="number-button tooltip" disabled>3</button>
      <button id="top-menu-page4" onclick="pageNumberMenuClicked('4')" class="number-button tooltip" disabled>4</button>
      <button id="top-menu-page5" onclick="pageNumberMenuClicked('5')" class="number-button tooltip" disabled>5</button>
    <div class="line"></div>
  </div>

  <div id="loader-container" style="display: block;">
    <div class="lds-default"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
  </div>

  <div id="page-intro" style="display: none;">
    <h2 id="page-title-placeholder"></h2>
    <p id="page-desc-placeholder"></p>
  </div>

  <div id="page1" class="page-container" style="display: none;">
    <!-- Questions for Page 1 -->
  </div>

  <div id="page2" class="page-container" style="display: none;">
    <!-- Questions for Page 2 -->
  </div>

  <div id="page3" class="page-container" style="display: none;">
    <!-- Questions for Page 3 -->
  </div>

  <div id="page4" class="page-container" style="display: none;">
    <!-- Questions for Page 4 -->
  </div>

  <div id="page5" class="page-container" style="display: none;">
    <!-- Questions for Page 5 -->
  </div>

  </div>

  <div id="bottom-buttons-container" class="prev-next-btns" style="display: none;">
    <div class="prev-next-btns-flex">
      <button class="prev-btn" onclick="prevPage()"></button>
      <button class="next-btn" onclick="nextPage()"></button>
      <button class="quit-btn" onclick="saveAndQuit()">שמור וצא</button>
    </div>
  </div>


  <script>
    let pageNumberByName;

    let global_currentPage = 1;
    let global_pageFirstTime = {
      1: false, // firstTime is on login
      2: true,
      3: true,
      4: true,
      5: true,
    }
    let global_myUser = null;
    let global_myDep = null;
    let global_myProjects = null;
    let global_pagesData = null;
    let global_currentProject = null;
    let global_missing_required = {
      1: [],
      2: [],
      3: [],
      4: [],
      5: []
    };

    // Official !!
    function saveAndChangePage(nextPage, prevProjectId) {
      nextPage = Number(nextPage)
      // save
      const finish = (nextPage == 6);
      const saved = savePageAnswers(global_currentPage, prevProjectId, finish)
      if (!saved) { return }

      if (finish) {
        const res = confirm("התשובות ישמרו ותתצבע התנתקות מיידית.");
        if (res) { populateThankYouPage(); }
        return; // no change page
      }

      global_currentPage = nextPage;

      if (global_pageFirstTime[nextPage]) {
        startLoad();
        const populate = (questionData) => {
          populatePage(nextPage, questionData)
        }
        google.script.run.withSuccessHandler(populate).getQuestionsForUser(global_myDep.id, global_currentProject.id, nextPage);
        global_pageFirstTime[nextPage] = false;
      } else {
        changePageNoLoad(nextPage)
      }
    }

    function pageNumberMenuClicked(numberClicked) { saveAndChangePage(Number(numberClicked), null) }

    function handleButtonsDisplay() {
      document.querySelectorAll('.prev-next-btns').forEach((container)=> {
        container.style.display = "block";

        container.querySelectorAll('.prev-btn').forEach((btn) => {
          btn.style.visibility = (global_currentPage == 1) ? 'hidden' : 'visible';
          btn.textContent = 'שמור וחזור';
        })
        container.querySelectorAll('.next-btn').forEach((btn) => {
          btn.style.visibility = 'visible';
          btn.textContent = (global_currentPage == 5) ? 'שמור' : 'שמור והמשך';
        })
        container.querySelectorAll('.quit-btn').forEach((btn) => {
          btn.style.display = (global_currentPage == 5) ? 'block' : 'none';
        })
      })
      
    }

    function highlightPageNumberButton(buttonsDisabled) {
      const topMenuPageButtons = document.querySelectorAll('.number-button')
      topMenuPageButtons.forEach(b => {
        b.classList.remove('menu-button-highlighted')
        b.disabled = buttonsDisabled
      })
      document.getElementById(`top-menu-page${global_currentPage}`).classList.add('menu-button-highlighted')

    }
    function hideAllPages() {
      const allPages = document.querySelectorAll('.page-container')
      allPages.forEach(p => { p.style.display = 'none' })
      document.getElementById('page-intro').style.display = "none"
    }
    function specificRestrictions() {
      // in pages 1,2,5 not possible to reSelect, also if same proj
      const depPages = [pageNumberByName['Readiness'], pageNumberByName['Barrier'], pageNumberByName['Training']]
      const isDepPage = (depPages.includes(global_currentPage))

      const projNameContainer = document.getElementById('project-name-container');
      const projDDContainer = document.getElementById('project-dropdown');
      if (isDepPage) {
        projNameContainer.style.visibility = 'hidden';
        projDDContainer.style.visibility = 'hidden';
      }
      else { // project page
        projNameContainer.style.visibility = 'visible';
        projDDContainer.style.visibility = 'visible';

        const dropdown = document.getElementById('project-selection-dropdown');
        const sameProj = (dropdown.value == global_currentProject.id)
        document.getElementById('change-project').disabled = sameProj; // btn
      }
      

      // only funded projects have MS Page
      const msPageNum = pageNumberByName['MS'];
      const topMenuMSPage = document.getElementById(`top-menu-page${msPageNum}`);
      if (global_currentProject.isFunded) {
        topMenuMSPage.classList.remove(`page-ms-disabled`);
        topMenuMSPage.disabled = false;
      } else {
        topMenuMSPage.classList.add(`page-ms-disabled`);
        topMenuMSPage.disabled = true;
      }
      // buttons according to relevant page
      handleButtonsDisplay();
    }
    function hideNavBtns() {
      document.querySelectorAll('.prev-next-btns').forEach((container) => {
        container.style.display = "none"
      })
    }
    function hideProjectDDandName() {
      const projNameContainer = document.getElementById('project-name-container');
      const projDDContainer = document.getElementById('project-dropdown');
      projNameContainer.style.visibility = 'hidden';
      projDDContainer.style.visibility = 'hidden';
    }
    function startLoad() {
      highlightPageNumberButton(true); // true for disable
      hideAllPages();
      hideNavBtns();
      hideProjectDDandName();
      document.getElementById('loader-container').style.display = 'block';
    }

    function changePageNoLoad() {
      highlightPageNumberButton(false); // false for not disable
      hideAllPages();

      showStuff()
      specificRestrictions()
    }

    function finishLoad() {
      const topMenuPageButtons = document.querySelectorAll('.number-button')
      topMenuPageButtons.forEach(b => { b.disabled = false }) // enable all buttons

      document.getElementById('loader-container').style.display = 'none'; // remove loader

      showStuff()
      specificRestrictions()
    }

    function showStuff() {
      document.getElementById('page-intro').style.display = 'block'; // show intro
      document.getElementById('page' + global_currentPage).style.display = 'block'; // show page
      updatePageIntro()
    }

    function updatePageIntro() {
      document.getElementById('page-title-placeholder').textContent = global_pagesData[global_currentPage].title;
      document.getElementById('page-desc-placeholder').innerHTML = global_pagesData[global_currentPage].desc;
    }
    function updateOfficeAndProject() {
      document.getElementById('office-name-placeholder').textContent = global_myDep.name;
      document.getElementById('project-name-placeholder').textContent = global_currentProject.name;
    }

    function populatePage(pageNum, questionData) {
      if (pageNum == pageNumberByName['MS']) {// special ones
        google.script.run.withSuccessHandler((mile_stones_obj) => {
          populateQuestionsMSPage(questionData, mile_stones_obj.all_milestones_options, mile_stones_obj.miles_stones, mile_stones_obj.milestones_ans, pageNum);
        }).getMilesStones(global_currentProject.id);
        return; // this is it for ms page
      } 
      populateQuestions(questionData, pageNum); // for all except MS page
      if (pageNum == pageNumberByName['Training']) {
        google.script.run.withSuccessHandler(sectionData => {
          renderRolesSection(questionData, sectionData);
        }).getMyRolesAndTrainings(global_myDep.id);
      }
    }

    function populateThankYouPage() {
      document.body.innerHTML = "";      

      const container = document.createElement("div");
      container.id = "page-thank-you";
      const msgWrap = document.createElement("div");
      msgWrap.className = "group-container";

      const msgH2 = document.createElement('h2');
      msgH2.innerHTML = "השאלון הסתיים." + "<br>" + "תודה רבה על שיתוף הפעולה." + "<br>" + "ניתן לחזור בעתיד לשאלות שלא נענו."

      msgWrap.appendChild(msgH2);
      container.appendChild(msgWrap);
      document.body.appendChild(container);
    }

    function populateProjectDropdown() {
      const projects = global_myProjects;
      let projectSelect = document.getElementById('project-selection-dropdown');
      projectSelect.innerHTML = ''; // Clear existing options
      projects.forEach(function(project) {
        let option = document.createElement('option');
        option.value = project.id; // Assuming project object has an id property
        option.textContent = project.name; // Assuming project object has a name property
        projectSelect.appendChild(option);
      });
    }
    function selectProjectInDropdown(selectElement) {
      const disable = (selectElement.value == global_currentProject.id) // disable if same proj id
      document.getElementById('change-project').disabled = disable;
    }
    function confirmProjectChange() {
      // change and replace Questions
      const dropdownElement = document.getElementById('project-selection-dropdown');
      // in order to save answers
      const prevProjectId = global_currentProject.id
      global_currentProject = global_myProjects.find((proj) => proj.id == dropdownElement.value);
      document.getElementById('change-project').disabled = true;
      updateOfficeAndProject()

      // first time again
      global_pageFirstTime[pageNumberByName['DT']] = true
      global_pageFirstTime[pageNumberByName['MS']] = true

      // fetch questions again!
      saveAndChangePage(pageNumberByName['DT'], prevProjectId)
    }

    function generateRandomId(length = 5) {
      let result = '';
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }

    const createInputTypeDropdown = (options, answer) => {
      const inputElement = document.createElement('select');
      let blankOption = document.createElement('option');
      blankOption.value = ''; 
      blankOption.textContent = 'בחר';
      inputElement.appendChild(blankOption);
      options.forEach(function(option) {
        let optionElement = document.createElement('option');
        optionElement.value = option;
        optionElement.textContent = option;
        if (option === answer) { 
          optionElement.selected = true; 
        }
        inputElement.appendChild(optionElement);
      });
      return inputElement;
    }
    const createInputTypeNumber = (answer) => {
      const inputElement = document.createElement('input');
      if (answer) { inputElement.classList.add('input-gray-bg') }
      inputElement.type = 'number';
      inputElement.value = answer;
      return inputElement;
    }
    const createInputTypeDate = (answer) => { 
      const inputElement = document.createElement('input');
      inputElement.type = 'date';
      if (answer) {
        inputElement.classList.add('input-gray-bg')
        let date = new Date(answer);
        date.setDate(date.getDate() + 1); //idk why i need to add 1 to the day. but it works this way
        answer = date.toISOString().split('T')[0];
      }
      inputElement.value = answer;
      return inputElement;
    }
    const createInputTypeYes_No = (answer, ques_name) => {
      const yes_no_values = ['כן', 'לא'];
      const radioContainer = document.createElement('div');
      radioContainer.style = "display: flex; flex-direction: column;"
      let radio;
      yes_no_values.forEach(val => {
        radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = ques_name;
        radio.value = val;
        if (answer === val) {
          radio.checked = true;
        }
        const label = document.createElement('label');
        const span = document.createElement('span');
        span.textContent = val;
        label.appendChild(radio);
        label.appendChild(span);
        radioContainer.appendChild(label);
      })
      if (!answer) { // default no
        const radios = radioContainer.querySelectorAll('input[type="radio"]');
        radios[radios.length-1].checked = true;
      }
      return radioContainer;
    }
    const createInputTypeText = (answer, long) => {
      const inputElement = document.createElement('input');
      if (answer) { inputElement.classList.add('input-gray-bg') }
      if (long) { inputElement.classList.add('input-long') }
      inputElement.type = 'text';
      inputElement.value = answer || "";
      return inputElement;
    }
    const createInputTypeTextArea = (answer) => {
      const inputElement = document.createElement('textarea');
      if (answer) { inputElement.classList.add('input-gray-bg') }
      inputElement.value = answer;
      return inputElement;
    }
    const createInputTypeCheckboxMultiChoice = (options, answer, max_choice) => {
      const inputElement = document.createElement('div');
      inputElement.classList.add('multi-checkbox-div')

      options.forEach((option) => {
        const label = document.createElement('label');
        
        const checkbox = document.createElement('input')
        checkbox.type = 'checkbox';
        checkbox.value = option;
        checkbox.checked = answer && answer.split('$').includes(option.toString());
        if (max_choice) { // some questions have no limit
          checkbox.addEventListener('change', () => {
            const checkedCheckboxes = inputElement.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedCheckboxes.length > max_choice) {
              checkbox.checked = false;
            }
          });
        }
        
        label.appendChild(checkbox);
        const span = document.createElement('span');
        span.textContent = option;
        label.appendChild(span);
        inputElement.appendChild(label);
      });
      return inputElement;
    }

    function createRequiredStar() {
      const requiredStar = document.createElement('span');
      requiredStar.textContent = '*';
      requiredStar.classList.add('required-star');
      return requiredStar;
    }
    function createTooltip(info) {
      const tooltip = document.createElement('span');
      tooltip.classList.add('info-icon');
      tooltip.classList.add('tooltip');
      tooltip.innerHTML = '&#9432;';
      const infoText = document.createElement('span');
      infoText.classList.add('tooltiptext');
      infoText.innerHTML = info;
      tooltip.appendChild(infoText);
      return tooltip;
    }

    function generatePreInputText(questionObj) {
      const textContainer = document.createElement('div');
      textContainer.classList.add('question-text')
      const q_desc = document.createElement('span');
      q_desc.innerHTML = questionObj.question;
      q_desc.classList.add('question-desc');
      textContainer.appendChild(q_desc);
      if (questionObj.required) {
        const requiredStar = createRequiredStar()
        textContainer.appendChild(requiredStar);
      }

      if (questionObj.info) {
        const tooltip = createTooltip(questionObj.info)
        textContainer.appendChild(tooltip);
      }
      // all text with addings
      return textContainer;
    }
    function generateOnlyInputByType(questionObj) {
      const funcs = {
        'dropdown': () => createInputTypeDropdown(questionObj.options, questionObj.answer),
        'Yes_No': () => createInputTypeYes_No(questionObj.answer, questionObj.ques_name),
        'Number': () => createInputTypeNumber(questionObj.answer),
        'Date': () => createInputTypeDate(questionObj.answer),
        'Checkbox_Multi_Choice': () => createInputTypeCheckboxMultiChoice(questionObj.options, questionObj.answer, questionObj.max_choice),
        'Text': () => createInputTypeText(questionObj.answer, false),
        'Textarea': () => createInputTypeTextArea(questionObj.answer),
        'TextLong': () => createInputTypeText(questionObj.answer, true),
      }
      const inputFunc = funcs[questionObj.type];
      const inputElement = inputFunc ? inputFunc() : funcs['Text']() // not suppose to get to Default
      return inputElement;
    }

    function generateFullInput(questionObj) {
      let questionElement = document.createElement('div');
      questionElement.classList.add('single-question-container')
      if (questionObj.ques_number) {
        questionElement.id = `${questionObj.ques_number}`
      }
      if (questionObj.ans_next_to_ques) {
        questionElement.classList.add('single-question-flex')
      }
      const textContainer = generatePreInputText(questionObj);
      questionElement.appendChild(textContainer);
      
      const inputElement = generateOnlyInputByType(questionObj)

      if (questionObj.required) { inputElement.required = true; }
      if (inputElement.localName === 'div') { // Checkbox_Multi_Choice questions
        inputElement.id = questionObj.ques_name;
      } else { // all other
        inputElement.name = questionObj.ques_name;
      }
      questionElement.appendChild(inputElement);
      return questionElement;
    }

    function renderRolesSection(questionData, sectionData) {
      const loader = document.getElementById('insert-roles-section-here') // change later when adding real loader
      loader.innerHTML = "";
      const groupContainer = loader.parentElement;

      // Column headers
      const tableQuestions = questionData.filter(q => (q.position == 'Table'))
      const headersList = [...tableQuestions];
      headersList.unshift({question: "שם התפקיד", ques_name: 'row_title', type: "Fixed"}); // first
      headersList.push({question: "פירוט הכשרות", ques_name: 'open_popup', type: "Fixed"}); // last

      const table = createTrainingPageGenericTable('role', headersList, sectionData.allRoles, sectionData.depRolesData, null)
      groupContainer.appendChild(table)
      generateTrainingPagePopupAndContent(questionData, sectionData)
    }
    
    function createTrainingPageGenericTable(title, headersList, allItems, dataObject, roleID) {
      // table setters
      const table = document.createElement('table');
      table.classList.add('question-table', 'trainings-page-table', `${title}-table`);

      const headerRow = document.createElement('tr');
      headersList.forEach(questionObj => {
        const headerCell = document.createElement('th');
        headerCell.textContent = questionObj.question;
        headerRow.appendChild(headerCell);
      });
      table.appendChild(headerRow);

      allItems.forEach((item) => {
        const row = document.createElement('tr');
          row.id = `${title}-${item.id}`;
          if (item.cloudVendor) {
            row.classList.add(`CLOUD-${item.cloudVendor.trim().toUpperCase()}`); // AWS GCP
          }
          row.key = item.id;
            // loop through each question and create cells
            headersList.forEach(questionObj => {
              const cell = document.createElement('td');
              let inputElement;
              if (questionObj.type == 'Fixed') {
                if (questionObj.ques_name == 'row_title') {
                  inputElement = document.createElement('div');
                  inputElement.className = "roles-table-name-cell";
                  h3 = document.createElement('h3');
                  h3.textContent = item.name;
                  inputElement.appendChild(h3)
                  if (item.desc) {
                    const tooltip = createTooltip(item.desc);
                    inputElement.appendChild(tooltip)
                  }
                } else if (questionObj.ques_name == 'open_popup') {
                  inputElement = createOpenTrainingsPopupCell(item.id, row)
                }
              } else {
                let curr_ans;
                if (dataObject[item.id]) {
                  curr_ans = dataObject[item.id][questionObj.ques_name];
                }
                questionObj.answer = curr_ans;
                inputElement = generateOnlyInputByType(questionObj)
                const inputName = roleID ? `${questionObj.ques_name},Role_ID=${roleID},Training_ID=${item.id}` : `${questionObj.ques_name},Role_ID=${item.id}`
                inputElement.name = inputName;
                inputElement.onchange = rolesTableInputChange
              }
              cell.appendChild(inputElement);
              row.appendChild(cell);
            });
            table.appendChild(row);
      })
      return table;
    }
    function handleRoleOpenBtn(tr, openBtn) {
      const hasValue = roleRowHasValue(tr); // disable if no value
      openBtn.disabled = !hasValue;
      openBtn.classList.toggle('tooltip', !hasValue); // add tooltip if no value
    }
    function rolesTableInputChange(e) {
      const tr = e.target.closest('tr');
      const openBtn = tr.querySelector('.expand-btn');
      if (openBtn) {
        handleRoleOpenBtn(tr, openBtn)
      }
    }
    function roleRowHasValue(tr) {
      const inputs = tr.querySelectorAll('input[type="number"]');
      
      for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].value && inputs[i].value > 0) {
          return true;
        }
      }
      return false;
    }
    function displayRolePopup(open, roleID) {
      const popup = document.getElementById('role-popup');
      popup.className = open ? 'show' : 'hide';
      if (open) {
        const cloudQ = document.querySelector('select[name="Training_General_3"]');
        let cloudVendor = cloudQ?.value?.toUpperCase() //! todo change if q number changes

        cloudVendor = (cloudVendor == 'AWS' || cloudVendor == 'GCP') ? cloudVendor : 'AWS+GCP';

        const cloudRows = document.querySelectorAll(`#role-popup tr.CLOUD-AWS, #role-popup tr.CLOUD-GCP`);


        Array.from(cloudRows).forEach(tr => {
          if (cloudVendor == 'AWS' || cloudVendor == 'GCP') {
            if (tr.classList.contains(`CLOUD-${cloudVendor}`)) {
              tr.classList.remove('hide-row');
            } else {
              tr.classList.add('hide-row');
            }
          } else {
            tr.classList.remove('hide-row');
          }
        })
        if (roleID) {
          const allRoles = document.querySelectorAll('.single-role-popup-data')
          allRoles.forEach(roleContent => {
            roleContent.style.display = 'none';
          })
          const current = document.getElementById(`popup-role-${roleID}`);
          current.style.display = 'block';
          current.querySelector('.cloud-placeholder').textContent = cloudVendor;
        }
      }
    }
    function generatePopupDataSingleRole(roleObj, popupQuestions, trainingsList, trainingsData) {
      const content = document.createElement('div');
      content.id = `popup-role-${roleObj.id}`
      content.classList.add('single-role-popup-data')
      content.style.display = 'none';

      const topRow = document.createElement('div');
      topRow.className = "popup-top-row";

      const filler = document.createElement('div');
      filler.className = "flex-item";
      // Create the close button
      const closeButton = document.createElement('span');
      closeButton.className = 'close-btn';
      closeButton.innerHTML = '&times;';
      closeButton.onclick = () => { displayRolePopup(false) }
      filler.appendChild(closeButton);

      const roleTitle = document.createElement('h2');
      roleTitle.textContent = roleObj.name;
      roleTitle.className = "flex-item";

      const btnContainer = document.createElement('div');
      btnContainer.className = "flex-item";
      const saveBtn = document.createElement('button');
      saveBtn.textContent = 'שמור';
      saveBtn.onclick = () => displayRolePopup(false)
      btnContainer.appendChild(saveBtn);

      topRow.appendChild(filler);
      topRow.appendChild(roleTitle);
      topRow.appendChild(btnContainer);
      content.appendChild(topRow);

      const roleDesc = document.createElement('h4');
      roleDesc.textContent = roleObj.desc;
      content.appendChild(roleDesc);

      const cloud = document.createElement('div');
      cloud.className = "cloud-data";

      const cloudLabel = document.createElement('span');
      cloudLabel.textContent = "הכשרות בסביבת ענן:"
      cloudLabel.className = "cloud-label";

      const cloudVendor = document.createElement('span');
      cloudVendor.className = "cloud-placeholder";

      cloud.appendChild(cloudLabel);
      cloud.appendChild(cloudVendor);
      content.appendChild(cloud);

      // Column headers
      const tableQuestions = popupQuestions.filter(q => (q.ques_name == "Training_1"))
      const headersList = [...tableQuestions];
      headersList.unshift({question: "שם ההכשרה", ques_name: 'row_title', type: "Fixed"}); // first
      
      if (trainingsList.some(t => t.managmentJourney)) { // if some have managmentJourney
        const groupedTrainings = trainingsList.reduce((result, t) => {
          (result[t.managmentJourney] = result[t.managmentJourney] || []).push(t);
          return result;
        }, {});

        Object.entries(groupedTrainings).forEach(([journey, journeyTrainings]) => {
          const journeyContainer = document.createElement('div');
          journeyContainer.className = "training-journey-container";
          const h3 = document.createElement('h3');
          h3.textContent = journey;
          const table = createTrainingPageGenericTable('training', headersList, journeyTrainings, trainingsData, roleObj.id)
          
          journeyContainer.appendChild(h3);
          journeyContainer.appendChild(table);
          content.appendChild(journeyContainer);
        });

      } else {
        const table = createTrainingPageGenericTable('training', headersList, trainingsList, trainingsData, roleObj.id)
        content.appendChild(table);
      }
      return content;

    }
    function generateTrainingPagePopupAndContent(questionData, sectionData) {
      // Create the popup
      const popup = document.createElement('div');
      popup.className = 'hide';
      popup.id = 'role-popup';
      document.getElementById(`page${pageNumberByName['Training']}`).appendChild(popup);

      // Create the popup content
      const popupContent = document.createElement('div');
      popupContent.className = 'popup-content';

      const popupQuestions = questionData.filter(q => (q.position == 'Popup'))
      sectionData.allRoles.forEach(role => {
        const content = generatePopupDataSingleRole(
          role,
          popupQuestions,
          sectionData.allTrainings[role.trainingPathID] || [],
          sectionData.depTrainingData[role.id] || {}
        );

        const extraQ = popupQuestions.filter(q => (q.ques_name == "Training_Roles_3"))
        let extraInput;
        if (extraQ.length) {
          const q = {...extraQ[0]};
          q.answer = sectionData.depRolesData[role.id] ? sectionData.depRolesData[role.id][extraQ[0].ques_name] : ""
          q.ques_name = `${extraQ[0].ques_name},Role_ID=${role.id}`
          extraInput = generateFullInput(q)
        }

        content.appendChild(extraInput)
        popupContent.appendChild(content)
      })
      popup.appendChild(popupContent);
    }
    
    function populateQuestionsMSPage(questionData, all_milestones_options, milestones, milestones_ans, pageNumber) {
      document.getElementById('loader-container').style.display = 'none';
      const questionsDiv = document.getElementById(`page${pageNumber}`);
      questionsDiv.classList.add('group-container')
      questionsDiv.style.display = 'block';
      questionsDiv.innerHTML = ''; // Clear existing content

      const pageTitle = document.createElement('h2');
      pageTitle.innerHTML = 'רשימת אבני הדרך בפרוייקט מסוג ' + global_currentProject.typeName
      questionsDiv.appendChild(pageTitle)

      let table = document.createElement('table');
      table.classList.add('question-table');
      table.id = 'miles-table';

      const colWidths = [20, 20, 5, 5, 7, 7, 20, 6, 10] // hard coded
      const colgroup = document.createElement('colgroup');
      for (let i=0; i < 9; i++) {
        const col = document.createElement('col');
        col.style.width = colWidths[i] + '%';
        colgroup.appendChild(col)
      }
      table.appendChild(colgroup)

      // Column headers
      let headerRow = document.createElement('tr');
      headerRow.id = 'header-row';
      let nameHeader = document.createElement('th');
      nameHeader.textContent = 'אבן דרך';
      headerRow.appendChild(nameHeader);
      questionData.forEach(function (questionObj) {
        let headerCell = document.createElement('th');
        headerCell.textContent = questionObj.question;
        headerRow.appendChild(headerCell);
      });
      table.appendChild(headerRow);
      // Loop through each milestone and create a row
      for (let ml_stone_id in milestones) {
          // Take all milestones created that fit this milestone title.
          let curr_miles_stones = {};
          for (let ml_full_id in milestones_ans) {
              if (ml_full_id.startsWith(ml_stone_id + '_')) {
                  curr_miles_stones[ml_full_id] = milestones_ans[ml_full_id];
              }
          }
          if (Object.keys(curr_miles_stones).length === 0) {
            const ms_unique_id = generateRandomId(5);
            curr_miles_stones[ml_stone_id + '_' + ms_unique_id] = {
                'MS_Name': '',
                'MS_Start_Date': '',
                'MS_End_Date': '',
                'MS_Status': '',
                'MS_Buying_Required': '',
                'MS_Product_Desc': '',
                'MS_Product_Done': ''
            };
          }
          for (let ml_full_id in curr_miles_stones) {
            const row = createMileStoneRow(questionData, all_milestones_options, ml_full_id, curr_miles_stones[ml_full_id])
            table.appendChild(row)
          }
        }
      questionsDiv.appendChild(table);
      finishLoad();
    }
    function createOpenTrainingsPopupCell(roleID, tr) {
      const container = document.createElement('div');
      container.style.margin = "auto";

      const openBtn = document.createElement('button');
      openBtn.className = "expand-btn";

      const infoText = document.createElement('span');
      infoText.classList.add('tooltiptext');
      infoText.innerHTML = "נא למלא מספר בעלי תפקיד.";
      openBtn.appendChild(infoText);

      handleRoleOpenBtn(tr, openBtn);

      const img = document.createElement('img');
      img.className = "expand-icon";
      img.src = "https://i.ibb.co/9NqLCWw/expand.png";
      img.alt = "expand"
      openBtn.onclick = () => { displayRolePopup(true, roleID) }
      openBtn.appendChild(img);
      container.appendChild(openBtn);
      return container;
    }
    // "delete" and "+" on same cell
    function createMileStoneButtonsCell(questionData, milestones) {
      let btnsCell = document.createElement('td');
      let btnsDiv = document.createElement('div');
      btnsDiv.classList.add('btns-cell');
      // Add "Delete" button for every row
      let deleteButton = document.createElement('button');
      deleteButton.innerHTML = '<i class="fa fa-trash-o"></i>';
      deleteButton.onclick = function () {
        let rowId = this.closest('tr').id;
        let idParts = rowId.split('_'); 
        let id_ml_stone = idParts[0]; 
        if (milestones[id_ml_stone] && milestones[id_ml_stone].required) {
          // Check if there is at least another row with the same id_ml_stone before the underscore
          let otherRowsExist = Array.from(document.querySelectorAll('tr[id^="' + id_ml_stone + '_"]')).some(function (tr) {
            return tr.id !== rowId; // Check if the row ID is not the same as the current row's ID
          });
          if (!otherRowsExist) {
            alert("אבן דרך זו היא חובה.");
            return; 
          }
        }
        this.closest('tr').remove();
      };
      // Add 'add' button for every row
      let addButton = document.createElement('button');
      addButton.innerHTML = '<i class="fa fa-solid fa-plus"></i>';
      addButton.onclick = function (event) {
        addMileStone(questionData, milestones, event.target.closest('tr'));
      }
      btnsDiv.appendChild(deleteButton);
      btnsDiv.appendChild(addButton);
      btnsCell.appendChild(btnsDiv);
      return btnsCell;
    }

    function addMileStone(questionData, milestones, rowClicked) {
      const row = createMileStoneRow(questionData, milestones, null, null);
      const table = rowClicked.parentElement;
      table.insertBefore(row, rowClicked.nextSibling);
    }

    // both ml_full_id and answers is to understand if new
    function createMileStoneRow(questionData, milestones, ml_full_id, answers) {
      const row = document.createElement('tr');
      const nameCell = document.createElement('td');
      let ml_stone_id, ml_unique_id;
      const textContainer = document.createElement('div');
      if (answers) {
        row.id = ml_full_id;
        ml_stone_id = ml_full_id.split('_')[0]
        ml_unique_id = ml_full_id.split('_')[1]
        const mlTitle = document.createElement('span');
        mlTitle.textContent = milestones[ml_stone_id].ml_title; // Name of the milestone
        textContainer.appendChild(mlTitle);
        if (milestones[ml_stone_id].required) {
          row.classList.add('required-row')
          const requiredStar = document.createElement('span');
          requiredStar.textContent = '*';
          requiredStar.classList.add('required-star');
          textContainer.appendChild(requiredStar);
        }
        nameCell.appendChild(textContainer);
      } else {
        let dropdown = document.createElement('select');

        for (let stone_id in milestones) {
          let option = document.createElement('option');
          const unique_id = generateRandomId(5);
          ml_full_id = stone_id + '_' + unique_id;
          option.value = ml_full_id;
          option.textContent = milestones[stone_id].ml_title;
          dropdown.appendChild(option);
        }
        dropdown.onchange = (opt) => {
          const value = opt.target.value;
          row.id = value;
        }
        nameCell.appendChild(dropdown);
      }
      row.appendChild(nameCell);
      // loop through each question and create cells
      questionData.forEach(function (questionObj) {
        const cell = document.createElement('td');
        // create appropriate input elements based on question type
        let question_unique_name = questionObj.ques_name;
        questionObj['answer'] =  answers ? answers[question_unique_name] : "";
        const inputElement = generateOnlyInputByType(questionObj);
        inputElement.name = question_unique_name + '_' + ml_full_id;
        cell.appendChild(inputElement);
        row.appendChild(cell);
      });
      const btnsCell = createMileStoneButtonsCell(questionData, milestones)
      row.appendChild(btnsCell);
      return row;
    }

    const groupQuestionsByTitle = (questionData) => {
      return questionData.reduce((grouped, obj) => {
          const { title, ...rest } = obj;
          const index = grouped.findIndex(item => item[0].title === title);
          if (index === -1) { grouped.push([{ title, ...rest }]) }
          else { grouped[index].push({ title, ...rest }) }
          return grouped;
      }, []);
    }
    const groupQuestionsByPosition = (questionData) => {
      // Create an object to hold arrays of objects grouped by position
      const grouped = questionData.reduce((grouped, ques) => {
        // Check if the position exists in the accumulator, if not, initialize it with an empty array
        if (!grouped[ques.position]) {
          grouped[ques.position] = [];
        }
        // Push the current object to the corresponding position array
        grouped[ques.position].push(ques);
        return grouped;
      }, {});

      // Define the order of types
      const order = ['Pre', 'Post'];

      const ghostGroup = [{
        emptyGroup: true,
        title: 'איוש תפקידים - ענן נימבוס',
      }]
      // Map over the order and return arrays of objects for each type, filtering out undefined types
      const sections = order.map(pos => grouped[pos]).filter(Boolean);
      sections.splice(1, 0, ghostGroup); // the empty section
      return sections;
    }
    const createLoader = () => {
      const elem = document.createElement('p');
      elem.id = "insert-roles-section-here";
      elem.innerHTML = "<h2>אנחנו טוענים את השאלות...</h2>";
      return elem;
    }

    // for all but ms page
    function populateQuestions(questionData, pageNum) {
      document.getElementById('loader-container').style.display = 'none';
      const questionsDiv = document.getElementById(`page${pageNum}`);
      questionsDiv.style.display = 'block';
      questionsDiv.innerHTML = ''; // clear existing content
      let currentGroup = ''; 
      const currentGroupContainer = document.createElement('div'); 
      // Grouping the questions by title
      let questionsGrouped = (pageNum === pageNumberByName['Training']) ? groupQuestionsByPosition(questionData) : groupQuestionsByTitle(questionData);

      // if (pageNum === pageNumberByName['Training']) { questionsGrouped = [] } // page Training disabled
      questionsGrouped.forEach((group) => {
        if (!group.length) {return}
        const groupContainer = document.createElement('div'); 
        groupContainer.classList.add('group-container')

        if (group[0].title == "תכנון הפרוייקט") {
          groupContainer.style.position = "relative"
          const img = createImagePlanning();
          groupContainer.appendChild(img);
        }

        const titleElement = document.createElement('h2');
        titleElement.textContent = group[0].title;
        groupContainer.appendChild(titleElement);
        currentGroup = group[0].title;
        if (group[0].subTitle) {
            let subtitleElement = document.createElement('p');
            subtitleElement.innerHTML = group[0].subTitle;
            groupContainer.appendChild(subtitleElement);
        }

        // questions
        group.forEach((questionObj) => {
          let questionElement;
          if (questionObj.emptyGroup) { // mikta 2 in page Training
            questionElement = createLoader();
          } else { // regular
            questionElement = generateFullInput(questionObj);
          }
          groupContainer.appendChild(questionElement);
        });
        questionsDiv.appendChild(groupContainer);
      })
      finishLoad();
    }

    function createImagePlanning() {
      let img = document.createElement('img');
      img.id = 'plan-image'
      img.src = 'https://storageaccountpbiema3c5.blob.core.windows.net/icons/Project_Cloud_Journey.png'; 
      return img
    }
    function createImageLogo() {
      let img = document.createElement('img');
      img.id = 'logo'
      img.src = 'https://www.gov.il/BlobFolder/office/improving-government-service-unit/en/Israel National Digital Agency_Logo.png'; 
      return img
    }

    // btnClickd: 'next' or 'prev'
    function getCorrectedNextPage(btnClickd) {
      // if not funded- no page MS!
      if (global_currentPage == 5 && btnClickd == 'next') {// last page save and stay
        const msg = "הנתונים נשמרים!" + "\n" + "ניתן להמשיך ולענות על שאלות."
        alert(msg);
        return 5
      }
      let newPage = (btnClickd == 'next') ? global_currentPage + 1 : global_currentPage - 1;
      if (!global_currentProject.isFunded && newPage == pageNumberByName['MS']) {
        newPage = (btnClickd == 'next') ? newPage + 1 : newPage - 1;
      }
      return newPage;
    }

    function saveAndQuit() {
      saveAndChangePage(6, null);
    }
    function nextPage() {
      const newPage = getCorrectedNextPage('next'); // if num6 its for finish!
      saveAndChangePage(newPage, null);
    }

    function prevPage() {
      const newPage = getCorrectedNextPage('prev');
      if (newPage >= 1) {
        saveAndChangePage(newPage, null);
      }
    }

    function msInputRequiredByName(inputName) {
      const questions = ["MS_Name", "MS_End_Date", "MS_Status"];
      return questions.some(q => inputName.includes(q));
    }
    function saveMSInputs(page) {
      const answers = {}
      const trElements = document.querySelectorAll('#page' + page + ' tr'); 
      trElements.forEach(function(tr, index) {
        if (tr.id !== 'header-row'){
          const isRowRequired = tr.classList.contains('required-row');
          let addToMissing = false;
          const rowAnswers = []; // for storing answers for this row
          const rowInputs = tr.querySelectorAll('input, select, textarea');
          rowInputs.forEach(function(rowInput) {
            if (isRowRequired && msInputRequiredByName(rowInput.name) && rowInput.value == "") {
              addToMissing = true;
            }
            rowAnswers.push(rowInput.value); 
          });
          if (rowAnswers.length == 8){// its usually 7. so it means this row was created by clicking 'Add'. change this to better implementation
            rowAnswers.shift();
          }
          if (addToMissing) { global_missing_required[page].push(index) }      
          answers[tr.id] = rowAnswers; // store row answers with row ID as key
        }
      });
      return answers;
    }
    function saveSingleInput(input, page) {
      const answers = {}
      // pages no MS
      if (input.type == 'radio') {
        if (input.checked) { answers[input.name] = input.value.trim() }
      }
      const simpleTypes = ['select-one', 'text', 'number', 'date']
      if (simpleTypes.includes(input.type)) {
        answers[input.name] = input.value.trim();
      }
      if (input.classList.contains("multi-checkbox-div")) { // multi
        const checked = input.querySelectorAll('input[type="checkbox"]:checked');
        const selectedOptions = Array.from(checked).map(c => c.value);;
        answers[input.id] = selectedOptions.join('$'); // Save selected options separated by $
      }
      if (input.required && !answers[input.name] && !answers[input.id]) {
        const wrapDiv = input.closest(".single-question-container");
        global_missing_required[page].push(wrapDiv['id'])
      }
      if (input.name) {
        if (answers[input.name] == "") {
          delete answers[input.name];
        }
      } else if (input.id) {
        if (answers[input.id] == "") {
          delete answers[input.id];
        }
      }
      return answers;
    }

    function savePageAnswers(pageNum, prevProjectId, finish) {
      global_missing_required[pageNum] = []
      let answers = {};
      // exclude multi-option, because it has a div wrapper (.multi-checkbox-div)
      const inputElements = document.querySelectorAll(
        `#page${pageNum} input:not([type="checkbox"]), #page${pageNum} select, #page${pageNum} .multi-checkbox-div`
      );
      if (pageNum == pageNumberByName['MS']) {
        answers = saveMSInputs(pageNum);
      } else {
        inputElements.forEach((input) => {
          const ansObj = saveSingleInput(input, pageNum)
          answers = { ...ansObj, ...answers }
        });
      }
      let errorMessage = "";
      if (finish) {
        errorMessage = "שים לב, לא ענית על מספר שאלות חובה בשאלון:\n";
        errorMessage += "לא ניתן לשמור ולצאת מהשאלון.";
        let allGood = true;
        for (let j=1; j<=5; j++) {
          if (!global_missing_required[j].length) { continue }
          if (j == pageNumberByName['MS']) {
            errorMessage += '\n' + `בעמוד ${j}, שורות: `
          } else {
            errorMessage += '\n' + `בעמוד ${j}, שאלות: `
          }
          errorMessage += global_missing_required[j].join(', ');
          allGood = false;
        }
        if (!allGood) { // error on the way
          alert(errorMessage);
          return false;
        }
      } else { // not finish
        if (global_missing_required[pageNum].length > 0) {
          if (pageNum == pageNumberByName['MS']) {
            errorMessage = "שים לב, לא ענית על מספר אבני דרך חובה בעמוד זה, בשורות: \n";
          } else {
            errorMessage = "שים לב, לא ענית על מספר שאלות חובה בעמוד זה: \n";
          }
          errorMessage += global_missing_required[pageNum].join(', ');
          alert(errorMessage);
        }
      }
      console.log('answers')
      console.log(answers)
      // if (prevProjectId) use it
      const projectId = prevProjectId || global_currentProject.id;
      google.script.run.saveNewAnswers(pageNum, answers, projectId, global_myDep.id);
      return true;
    }

    function putTooltips() {
      Object.values(global_pagesData).forEach(p => {
        const btn = document.getElementById('top-menu-page' + p.number);
        let tooltip = document.createElement('span');
        tooltip.classList.add('tooltiptext');
        tooltip.innerHTML = p.title;
        btn.appendChild(tooltip);
      })
    }
    function fillGeneralData() {
      updateOfficeAndProject()
      populateProjectDropdown()
      putTooltips()
    }

    function updatePagesOrder(pagesData) {
      const pagesNewOrder = {}
      for (const [page, data] of Object.entries(pagesData)) {
        pagesNewOrder[data.prefix] = Number(page);
      }
      pageNumberByName = pagesNewOrder;
    }
    function updateGlobalState({ myUser, myDep, myProjects, pagesData }) {
      global_myUser = myUser;
      global_myDep = myDep;
      global_myProjects = myProjects;
      global_currentProject = global_myProjects[0];
      global_pagesData = pagesData;
      updatePagesOrder(pagesData);
    }

    function onStart() {
      google.script.run.withSuccessHandler((generalData) => {
        updateGlobalState(generalData)
        fillGeneralData()
        
        const populatePage1 = (questionData) => { populatePage(1, questionData) }
        google.script.run.withSuccessHandler(populatePage1).getQuestionsForUser(global_myDep.id, global_currentProject.id, 1);

      }).getUserRelevantData();
    }
    onStart()
  </script>
</body>
</html>
